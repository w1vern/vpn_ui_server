services:
  port_generator:
    build: .
    env_file:
      - .env
    command: bash -c "uvicorn port_generator:app --host 0.0.0.0 --port ${PORT_GENERATOR_PORT}"
    ports:
      - ${PORT_GENERATOR_PORT}:${PORT_GENERATOR_PORT}

  panel_setup:
    build: .
    env_file:
      - .env
    command: python panel_setup.py
    profiles:
      - with_panel_setup
    depends_on:
      3x-ui:
        condition: service_started

  3x-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    container_name: 3x-ui
    ports:
      - ${PANEL_PORT}:${PANEL_PORT}
    volumes:
      - ./x-ui/db/:/etc/x-ui/
      - ./x-ui/cert/:/root/cert/
      - ./x-ui/logs/:/var/log/
    environment:
      XRAY_VMESS_AEAD_FORCED: "false"
      X_UI_ENABLE_FAIL2BAN: "true"
    tty: true
    restart: unless-stopped
    profiles:
      - with_3x_ui
